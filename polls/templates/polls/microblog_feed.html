{% extends 'base_generic.html' %}

{% block title %}–õ–µ–Ω—Ç–∞ –º–∏–∫—Ä–æ–±–ª–æ–≥–æ–≤{% endblock %}

{% block content %}
<div>
    <h1>–ú–∏–∫—Ä–æ–±–ª–æ–≥–∏</h1>

    {% if user.is_authenticated %}
    <div>
        <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç</h3>
        <form method="post" action="{% url 'polls:create_post' %}">
            {% csrf_token %}
            <div>
                <textarea name="content" rows="4" placeholder="–ß—Ç–æ —É –≤–∞—Å –Ω–æ–≤–æ–≥–æ?" maxlength="1000" required></textarea>
            </div>
            <button type="submit">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
        </form>
    </div>
    <hr>
    {% endif %}

    <div>
        <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã</h2>

        {% for post in page_obj %}
        <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <img src="{{ post.author.profile.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 10px;">
                <div>
                    <h4 style="margin: 0;">
                        <a href="{% url 'polls:user_profile' post.author.username %}">{{ post.author.username }}</a>
                    </h4>
                    <small>{{ post.created_at|date:"d.m.Y H:i" }}</small>
                </div>

                {% if user == post.author %}
                <div style="margin-left: auto;">
                    <a href="{% url 'polls:edit_post' post.id %}" style="margin-right: 10px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="{% url 'polls:delete_post' post.id %}" style="color: red;">–£–¥–∞–ª–∏—Ç—å</a>
                </div>
                {% endif %}
            </div>

            <p>{{ post.content|linebreaks }}</p>

            <div style="display: flex; gap: 20px; margin-top: 10px;">
                <form method="post" action="{% url 'polls:like_post' post.id %}" class="like-form">
                    {% csrf_token %}
                    <button type="submit" style="border: none; background: none; cursor: pointer;">
                        {% if user.is_authenticated and user in post.likes.all %}
                        ‚ù§Ô∏è
                        {% else %}
                        ü§ç
                        {% endif %}
                        <span class="likes-count">{{ post.likes_count }}</span>
                    </button>
                </form>

                <span>üí¨ {{ post.get_comment_count }}</span>
            </div>

            <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
            <div style="margin-top: 15px;">
                <h5>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</h5>

                {% for comment in post.comments.all|slice:":5" %}
                <div style="background: #f5f5f5; padding: 10px; margin-bottom: 5px; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>{{ comment.author.username }}</strong>
                        <small>{{ comment.created_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    <p style="margin: 5px 0;">{{ comment.content }}</p>

                    {% if user == comment.author %}
                    <div>
                        <a href="{% url 'polls:edit_comment' comment.id %}" style="font-size: 12px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                        <a href="{% url 'polls:delete_comment' comment.id %}" style="font-size: 12px; color: red; margin-left: 10px;">–£–¥–∞–ª–∏—Ç—å</a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}

                {% if user.is_authenticated %}
                <form method="post" action="{% url 'polls:add_comment' post.id %}" style="margin-top: 10px;">
                    {% csrf_token %}
                    <input type="text" name="content" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." style="width: 100%; padding: 8px;" required>
                                        <button type="submit" style="margin-top: 5px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p>–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>
        {% endfor %}

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        <div style="margin-top: 20px;">
            {% if page_obj.has_previous %}
            <a href="?page=1">–ü–µ—Ä–≤–∞—è</a>
            <a href="?page={{ page_obj.previous_page_number }}">–ù–∞–∑–∞–¥</a>
            {% endif %}

            <span>–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}</span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">–í–ø–µ—Ä–µ–¥</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
            {% endif %}
        </div>
    </div>
</div>

<script>
// AJAX –¥–ª—è –ª–∞–π–∫–æ–≤
document.querySelectorAll('.like-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const url = this.action;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            const button = this.querySelector('button');
            const likesCount = this.querySelector('.likes-count');

            if (data.liked) {
                button.innerHTML = '‚ù§Ô∏è <span class="likes-count">' + data.likes_count + '</span>';
            } else {
                button.innerHTML = 'ü§ç <span class="likes-count">' + data.likes_count + '</span>';
            }
        });
    });
});
</script>
{% endblock %}